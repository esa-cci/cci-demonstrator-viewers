{"version":3,"kind":"Notebook","sha256":"ca4039be80c9054f0fa0afa15f6902583338c08d8cbc4eed34c3345c50323cc2","slug":"external-notebooks.esa-cci.ect-demonstrators.demonstrators.d3-js.d3-js-lc-classes","location":"/external_notebooks/esa-cci/ect-demonstrators/demonstrators/D3_js/D3_js_LC_Classes.ipynb","dependencies":[],"frontmatter":{"title":"Visualising Land Cover Class Change with Altair","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"github":"https://github.com/esa-cci/cci-notebook-viewers","subject":"CCI Examples","numbering":{"title":{"offset":5}},"source_url":"https://github.com/esa-cci/cci-notebook-viewers/blob/main/external_notebooks/esa-cci/ect-demonstrators/demonstrators/D3_js/D3_js_LC_Classes.ipynb","edit_url":"https://github.com/esa-cci/cci-notebook-viewers/edit/main/external_notebooks/esa-cci/ect-demonstrators/demonstrators/D3_js/D3_js_LC_Classes.ipynb","exports":[{"format":"ipynb","filename":"D3_js_LC_Classes.ipynb","url":"/cci-demonstrator-viewers/build/D3_js_LC_Classes-54d41fd0a503b5bdeb68eb0f3a7a85b4.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This notebook is one of three notebooks that serve to show how the ESA CCI Toolbox can be used with D3.js. Here, we will show how the classes of a Land Cover Dataset can be summed up and their change over time can be visualised in a D3.js chart accessed over the Altair library. Several preprocessing steps are applied, partly using operations from the CCI Toolbox.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FMFMDVW6CV"}],"key":"sOHcTydn1D"}],"key":"oRowfdDT6t"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For this notebook, we use the altair library. Install it into your Python environment if you haven’t already done so:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YMDvVuB7dB"}],"key":"NEZJMMdHQi"}],"key":"TSaoBkcQXR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# ! mamba install --yes altair","key":"x6MvhMwwli"},{"type":"outputs","id":"nqUF5kUVP0yB0VWLVpb_3","children":[],"key":"EnRXCVVXAS"}],"key":"U9OrGAvl2r"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we can make all the necessary imports.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aSTGM0mp6B"}],"key":"sP99io2imK"}],"key":"PBUZ8aOyQF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import altair as alt\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd\n\nfrom esa_climate_toolbox.core import get_op\nfrom esa_climate_toolbox.core import list_ecv_datasets\nfrom esa_climate_toolbox.core import open_data","key":"UXafYyMGnU"},{"type":"outputs","id":"zUYQ7wb5_aMrfowoxBMxh","children":[],"key":"bY5W1eBYWC"}],"key":"jkC2kRV4of"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We start by listing all the Land Cover Datasets. For more information on Land Cover Data, see here: ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"knn76XcuBd"},{"type":"link","url":"https://climate.esa.int/en/projects/land-cover/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"https://​climate​.esa​.int​/en​/projects​/land​-cover/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YsUwhY6K0d"}],"urlSource":"https://climate.esa.int/en/projects/land-cover/","key":"pETPHt3y6v"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CEOIjGkbQ6"}],"key":"PMcIHWVagg"}],"key":"lFwXPe1Vfh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"list_ecv_datasets(\"LC\")","key":"FTSDiMbhiZ"},{"type":"outputs","id":"0pmU42WO0nzGnrjh7Cltr","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":3,"metadata":{},"data":{"text/plain":{"content":"[('esacci.LC.13-yrs.L4.WB.ASAR.Envisat.Map.4-0.r1', 'esa-cci'),\n ('esacci.LC.5-yrs.L4.CHANGE.multi-sensor.multi-platform.HRLCC30-A01.v1-2.Africa',\n  'esa-cci'),\n ('esacci.LC.5-yrs.L4.CHANGE.multi-sensor.multi-platform.HRLCC30-A02.v1-2.Amazonia',\n  'esa-cci'),\n ('esacci.LC.5-yrs.L4.CHANGE.multi-sensor.multi-platform.HRLCC30-A03.v1-2.Siberia',\n  'esa-cci'),\n ('esacci.LC.5-yrs.L4.Map.multi-sensor.multi-platform.HRLC30-A01.v1-2.Africa',\n  'esa-cci'),\n ('esacci.LC.5-yrs.L4.Map.multi-sensor.multi-platform.HRLC30-A02.v1-2.Amazonia',\n  'esa-cci'),\n ('esacci.LC.5-yrs.L4.Map.multi-sensor.multi-platform.HRLC30-A03.v1-2.Siberia',\n  'esa-cci'),\n ('esacci.LC.yr.L4.LCCS.multi-sensor.multi-platform.Map.2-0-7.r1', 'esa-cci'),\n ('esacci.LC.yr.L4.Map.multi-sensor.multi-platform.HRLC10-A01.v1-2.Africa',\n  'esa-cci'),\n ('esacci.LC.yr.L4.Map.multi-sensor.multi-platform.HRLC10-A02.v1-2.Amazonia',\n  'esa-cci'),\n ('esacci.LC.yr.L4.Map.multi-sensor.multi-platform.HRLC10-A03.v1-2.Siberia',\n  'esa-cci'),\n ('esacci.LC.yr.L4.PFT.Unspecified.Unspecified.Map.2-0-8.r1', 'esa-cci'),\n ('ESACCI-LC-L4-LCCS-Map-300m-P1Y-1992-2015-v2.0.7b-kr1.1', 'esa-cci-kc'),\n ('ESACCI-LC-L4-PFT-Map-300m-P1Y-1992-2020-v2.0.8-kr1.1', 'esa-cci-kc'),\n ('ESACCI-LC-L4-LCCS-Map-300m-P1Y-1992-2015-v2.0.7b.zarr', 'esa-cci-zarr')]","content_type":"text/plain"}}},"children":[],"key":"qpJTVFx1LL"}],"key":"SGShgsx73P"}],"key":"pn4rGQ51nO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Of these, we open the one provided from the zarr store, using the toolbox’ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lQa52uRHwr"},{"type":"inlineCode","value":"open_data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Yyr5Xa9X9W"},{"type":"text","value":" function. Note this method returns a tuple, consisting of the data and its identifier. We are only interested in the data here.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TfsDvvNx29"}],"key":"cuioyblkZN"}],"key":"HSs8v4PI1x"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_ds, _ = open_data(\"ESACCI-LC-L4-LCCS-Map-300m-P1Y-1992-2015-v2.0.7b.zarr\", data_store_id=\"esa-cci-zarr\")\nlc_ds","key":"oBMso8QS2Z"},{"type":"outputs","id":"kIFXuv_PjDZlb6l_VlKb6","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"23091eb5e54710e409d264614e0356d0","path":"/cci-demonstrator-viewers/build/23091eb5e54710e409d264614e0356d0.html"},"text/plain":{"content":"<xarray.Dataset> Size: 4TB\nDimensions:              (time: 24, lat: 64800, lon: 129600)\nCoordinates:\n  * lat                  (lat) float32 259kB 90.0 90.0 89.99 ... -90.0 -90.0\n  * lon                  (lon) float32 518kB -180.0 -180.0 ... 180.0 180.0\n  * time                 (time) datetime64[ns] 192B 1992-07-02 ... 2015-07-03\nData variables:\n    change_count         (time, lat, lon) float32 806GB dask.array<chunksize=(1, 2592, 1296), meta=np.ndarray>\n    current_pixel_state  (time, lat, lon) float32 806GB dask.array<chunksize=(1, 2592, 1296), meta=np.ndarray>\n    lccs_class           (time, lat, lon) float32 806GB dask.array<chunksize=(1, 2592, 1296), meta=np.ndarray>\n    observation_count    (time, lat, lon) float32 806GB dask.array<chunksize=(1, 2592, 1296), meta=np.ndarray>\n    processed_flag       (time, lat, lon) float32 806GB dask.array<chunksize=(1, 2592, 1296), meta=np.ndarray>\nAttributes: (12/40)\n    Conventions:                CF-1.6\n    TileSize:                   2048:2048\n    catalogue_url:              https://catalogue.ceda.ac.uk/uuid/b382ebe6679...\n    cdm_data_type:              grid\n    comment:                    \n    contact:                    landcover-cci@uclouvain.be\n    ...                         ...\n    time_coverage_end:          20150703T000000Z\n    time_coverage_resolution:   P1Y\n    time_coverage_start:        20150703T000000Z\n    title:                      ESA CCI Land Cover Map\n    tracking_id:                12590bad-9014-4a91-9048-d06b67965490\n    type:                       ESACCI-LC-L4-LCCS-Map-300m-P1Y","content_type":"text/plain"}}},"children":[],"key":"yk633AM2jH"}],"key":"hnw2v160MO"}],"key":"CjYRhrkquE"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This dataset shows global land cover classes for the years from 1992 to 2015. The spatial is very large. We therefore want to focus on a smaller region, covering the Amazon rain forest. For subsetting, we use the toolbox’ ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ejYBAMuPcn"},{"type":"inlineCode","value":"subset_spatial","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yanzuYMEcx"},{"type":"text","value":" operation. The region is passed in as a string in the form of “min_lon, min_lat, max_lon, max_lat”.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HvibWW121x"}],"key":"oWn9Or9s0s"}],"key":"HO0YbvIEx5"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"subset_spatial = get_op(\"subset_spatial\")\nlc_ds_sub = subset_spatial(lc_ds, region=\"-61, -5, -47, 2\")\nlc_ds_sub","key":"G4MyjqaQNr"},{"type":"outputs","id":"JdVHHr63T0GGRubL0qkaX","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":5,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"4b2002e505f7c62cb7e285e75bfd3399","path":"/cci-demonstrator-viewers/build/4b2002e505f7c62cb7e285e75bfd3399.html"},"text/plain":{"content":"<xarray.Dataset> Size: 6GB\nDimensions:              (time: 24, lat: 2520, lon: 5042)\nCoordinates:\n  * lat                  (lat) float32 10kB 1.999 1.996 1.993 ... -4.996 -4.999\n  * lon                  (lon) float32 20kB -61.0 -61.0 -61.0 ... -47.0 -47.0\n  * time                 (time) datetime64[ns] 192B 1992-07-02 ... 2015-07-03\nData variables:\n    change_count         (time, lat, lon) float32 1GB dask.array<chunksize=(1, 2016, 1225), meta=np.ndarray>\n    current_pixel_state  (time, lat, lon) float32 1GB dask.array<chunksize=(1, 2016, 1225), meta=np.ndarray>\n    lccs_class           (time, lat, lon) float32 1GB dask.array<chunksize=(1, 2016, 1225), meta=np.ndarray>\n    observation_count    (time, lat, lon) float32 1GB dask.array<chunksize=(1, 2016, 1225), meta=np.ndarray>\n    processed_flag       (time, lat, lon) float32 1GB dask.array<chunksize=(1, 2016, 1225), meta=np.ndarray>\nAttributes: (12/42)\n    Conventions:                CF-1.6\n    TileSize:                   2048:2048\n    catalogue_url:              https://catalogue.ceda.ac.uk/uuid/b382ebe6679...\n    cdm_data_type:              grid\n    comment:                    \n    contact:                    landcover-cci@uclouvain.be\n    ...                         ...\n    time_coverage_start:        20150703T000000Z\n    title:                      ESA CCI Land Cover Map\n    tracking_id:                12590bad-9014-4a91-9048-d06b67965490\n    type:                       ESACCI-LC-L4-LCCS-Map-300m-P1Y\n    geospatial_bounds_crs:      CRS84\n    geospatial_bounds:          POLYGON((-61.002777099609375 -5.0, -61.002777...","content_type":"text/plain"}}},"children":[],"key":"X64vwZOkwK"}],"key":"zdWnrjXzkw"}],"key":"ZNkHFl4Gei"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now that we have made the dataset somewhat smaller, we may plot the data for the first and last timestep.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DWr0R8WPWQ"}],"key":"XAGpnpS1gL"}],"key":"h8nf36NtF9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%matplotlib inline\nlc_ds_sub.lccs_class.isel(time=0).plot(figsize=(10, 5))","key":"GMiTPZhxzj"},{"type":"outputs","id":"eorCv5rz3hn1KSntLrtGG","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"d8d6e538ac63338ed1f171f0ca55d579","path":"/cci-demonstrator-viewers/build/d8d6e538ac63338ed1f171f0ca55d579.png"},"text/plain":{"content":"<Figure size 1000x500 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"rN9RBHvi62"}],"key":"Fegkhi2IyT"}],"key":"q4B732sPeV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_ds_sub.lccs_class.isel(time=-1).plot(figsize=(10, 5))","key":"AcYWc2VH2c"},{"type":"outputs","id":"cGvT9vwgL_lmjMP0REDxi","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"6ed7feec61b7f3896cd4d3e1128ab952","path":"/cci-demonstrator-viewers/build/6ed7feec61b7f3896cd4d3e1128ab952.png"},"text/plain":{"content":"<Figure size 1000x500 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"izSoTh3DPk"}],"key":"MUQWKXFjGo"}],"key":"nDvujLaOJl"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"It seems there are some differences. It might be good to look them up in more detail. If we look at the metadata of ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"crnZjlRgKG"},{"type":"inlineCode","value":"lccs_class","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qhgVR92F2j"},{"type":"text","value":", we see that flags and their meanings are defined. We have a look at the flag values first.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ryts8ofiA6"}],"key":"QN0OktGPyj"}],"key":"wIqtg3Oqkc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_flag_values = np.array(lc_ds_sub.lccs_class.attrs.get(\"flag_values\"))\nlc_flag_values","key":"JRWtzGymSH"},{"type":"outputs","id":"LAwFWW8yJF5v6u4kdYeJd","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":8,"metadata":{},"data":{"text/plain":{"content":"array([   0,   10,   11,   12,   20,   30,   40,   50,   60,   61,   62,\n         70,   71,   72,   80,   81,   82,   90,  100,  110,  120,  121,\n        122, -126, -116, -106, -105, -104, -103,  -96,  -86,  -76,  -66,\n        -56,  -55,  -54,  -46,  -36])","content_type":"text/plain"}}},"children":[],"key":"BLjvi6X0O9"}],"key":"nG5ehRSoVy"}],"key":"RHkSquaf0j"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Apparently, there was a mix-up with unsigned values. To account for this, we add the value 256 to all negative flag values in this list (not in the dataset itself, where the values are fine).","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aMDY9PC1gG"}],"key":"AUnfxUzryw"}],"key":"zrVLle6Zwu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_flag_values = np.where(lc_flag_values < 0, lc_flag_values + 256, lc_flag_values).astype(np.uint8)\nlc_flag_values","key":"GbngFDiWpm"},{"type":"outputs","id":"yEEadsOpspmll0v5FxEZl","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":9,"metadata":{},"data":{"text/plain":{"content":"array([  0,  10,  11,  12,  20,  30,  40,  50,  60,  61,  62,  70,  71,\n        72,  80,  81,  82,  90, 100, 110, 120, 121, 122, 130, 140, 150,\n       151, 152, 153, 160, 170, 180, 190, 200, 201, 202, 210, 220],\n      dtype=uint8)","content_type":"text/plain"}}},"children":[],"key":"KrYOhMy81c"}],"key":"wihaPryO1g"}],"key":"xN3lHPok9s"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is better. We now extract the flag meanings. As these are given in one big string, we split it whenver we encounter a space.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cMb8qyPTF4"}],"key":"MdWaXZ5m7y"}],"key":"ExZUh7PHVC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_flag_meanings = lc_ds_sub.lccs_class.attrs.get(\"flag_meanings\")\nlc_flag_meanings = lc_flag_meanings.split(\" \")\nlc_flag_meanings","key":"OoP9rpOgL0"},{"type":"outputs","id":"MVBt2L4O-hhz-nTlvDceC","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":10,"metadata":{},"data":{"text/plain":{"content":"['no_data',\n 'cropland_rainfed',\n 'cropland_rainfed_herbaceous_cover',\n 'cropland_rainfed_tree_or_shrub_cover',\n 'cropland_irrigated',\n 'mosaic_cropland',\n 'mosaic_natural_vegetation',\n 'tree_broadleaved_evergreen_closed_to_open',\n 'tree_broadleaved_deciduous_closed_to_open',\n 'tree_broadleaved_deciduous_closed',\n 'tree_broadleaved_deciduous_open',\n 'tree_needleleaved_evergreen_closed_to_open',\n 'tree_needleleaved_evergreen_closed',\n 'tree_needleleaved_evergreen_open',\n 'tree_needleleaved_deciduous_closed_to_open',\n 'tree_needleleaved_deciduous_closed',\n 'tree_needleleaved_deciduous_open',\n 'tree_mixed',\n 'mosaic_tree_and_shrub',\n 'mosaic_herbaceous',\n 'shrubland',\n 'shrubland_evergreen',\n 'shrubland_deciduous',\n 'grassland',\n 'lichens_and_mosses',\n 'sparse_vegetation',\n 'sparse_tree',\n 'sparse_shrub',\n 'sparse_herbaceous',\n 'tree_cover_flooded_fresh_or_brakish_water',\n 'tree_cover_flooded_saline_water',\n 'shrub_or_herbaceous_cover_flooded',\n 'urban',\n 'bare_areas',\n 'bare_areas_consolidated',\n 'bare_areas_unconsolidated',\n 'water',\n 'snow_and_ice']","content_type":"text/plain"}}},"children":[],"key":"dShxMXsHB9"}],"key":"sHB8L7GgqR"}],"key":"inAjLLvpX6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we simply combine these to have pairs of flag values and flag meanings.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aK72XWYKmy"}],"key":"wXRpZH36bh"}],"key":"kXImQdFjfJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_flags = [(lc_flag_values[i], lc_flag_meanings[i]) for i in range(len(lc_flag_values))]\nlc_flags","key":"KBemU56xdd"},{"type":"outputs","id":"aCnL2tCreMdaqwfsnAeMM","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":11,"metadata":{},"data":{"text/plain":{"content":"[(np.uint8(0), 'no_data'),\n (np.uint8(10), 'cropland_rainfed'),\n (np.uint8(11), 'cropland_rainfed_herbaceous_cover'),\n (np.uint8(12), 'cropland_rainfed_tree_or_shrub_cover'),\n (np.uint8(20), 'cropland_irrigated'),\n (np.uint8(30), 'mosaic_cropland'),\n (np.uint8(40), 'mosaic_natural_vegetation'),\n (np.uint8(50), 'tree_broadleaved_evergreen_closed_to_open'),\n (np.uint8(60), 'tree_broadleaved_deciduous_closed_to_open'),\n (np.uint8(61), 'tree_broadleaved_deciduous_closed'),\n (np.uint8(62), 'tree_broadleaved_deciduous_open'),\n (np.uint8(70), 'tree_needleleaved_evergreen_closed_to_open'),\n (np.uint8(71), 'tree_needleleaved_evergreen_closed'),\n (np.uint8(72), 'tree_needleleaved_evergreen_open'),\n (np.uint8(80), 'tree_needleleaved_deciduous_closed_to_open'),\n (np.uint8(81), 'tree_needleleaved_deciduous_closed'),\n (np.uint8(82), 'tree_needleleaved_deciduous_open'),\n (np.uint8(90), 'tree_mixed'),\n (np.uint8(100), 'mosaic_tree_and_shrub'),\n (np.uint8(110), 'mosaic_herbaceous'),\n (np.uint8(120), 'shrubland'),\n (np.uint8(121), 'shrubland_evergreen'),\n (np.uint8(122), 'shrubland_deciduous'),\n (np.uint8(130), 'grassland'),\n (np.uint8(140), 'lichens_and_mosses'),\n (np.uint8(150), 'sparse_vegetation'),\n (np.uint8(151), 'sparse_tree'),\n (np.uint8(152), 'sparse_shrub'),\n (np.uint8(153), 'sparse_herbaceous'),\n (np.uint8(160), 'tree_cover_flooded_fresh_or_brakish_water'),\n (np.uint8(170), 'tree_cover_flooded_saline_water'),\n (np.uint8(180), 'shrub_or_herbaceous_cover_flooded'),\n (np.uint8(190), 'urban'),\n (np.uint8(200), 'bare_areas'),\n (np.uint8(201), 'bare_areas_consolidated'),\n (np.uint8(202), 'bare_areas_unconsolidated'),\n (np.uint8(210), 'water'),\n (np.uint8(220), 'snow_and_ice')]","content_type":"text/plain"}}},"children":[],"key":"j0Yp4tTaTm"}],"key":"KUYIJvGQDQ"}],"key":"pij6qIxGnY"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"As the metadata is prepared, we can continue with preparing the LC dataset to be used with Altair. Now, as Altair expects pandas dataframes, we need to convert it. We could use the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"voh7tmDApE"},{"type":"inlineCode","value":"to_dataframe","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zm6mo4rLX4"},{"type":"text","value":" operation from the toolbox (which eventually is used in the other notebooks), but here we want to apply an additional step, where we count the number of occurences per class in each year. We therefore write a dedicated function. As this takes a little time to complete, we print out the time as means to measure the progress.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nesT1pBAvH"}],"key":"XsI0j6frmo"}],"key":"qXhVd0StwM"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"lc_data = []\nfor i, t in enumerate(lc_ds_sub.time):\n    date = pd.Timestamp(t.values).strftime(\"%Y-%m-%d\")\n    print(date)\n    for lc_flag, lc_flag_name in lc_flags:\n        if lc_flag_name == \"no_data\":\n            continue\n        flag_count = (lc_ds_sub.isel(time=i)[\"lccs_class\"] == lc_flag).sum().values\n        lc_data.append({\n            \"date\": date,\n            \"lc_class\": lc_flag_name,\n            \"lc_count\": flag_count\n        })\ndf = pd.DataFrame(lc_data)\ndf","key":"FzRwLKuZAX"},{"type":"outputs","id":"LJyX_B_10xIAhrAwa2G-7","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"1992-07-02\n1993-07-03\n1994-07-03\n1995-07-03\n1996-07-02\n1997-07-03\n1998-07-03\n1999-07-03\n2000-07-02\n2001-07-03\n2002-07-03\n2003-07-03\n2004-07-02\n2005-07-03\n2006-07-03\n2007-07-03\n2008-07-02\n2009-07-03\n2010-07-03\n2011-07-03\n2012-07-02\n2013-07-03\n2014-07-03\n2015-07-03\n"},"children":[],"key":"d8qRR4gsA2"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":12,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>lc_class</th>\n      <th>lc_count</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1992-07-02</td>\n      <td>cropland_rainfed</td>\n      <td>3759</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1992-07-02</td>\n      <td>cropland_rainfed_herbaceous_cover</td>\n      <td>16131</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1992-07-02</td>\n      <td>cropland_rainfed_tree_or_shrub_cover</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1992-07-02</td>\n      <td>cropland_irrigated</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>1992-07-02</td>\n      <td>mosaic_cropland</td>\n      <td>312463</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>883</th>\n      <td>2015-07-03</td>\n      <td>bare_areas</td>\n      <td>574</td>\n    </tr>\n    <tr>\n      <th>884</th>\n      <td>2015-07-03</td>\n      <td>bare_areas_consolidated</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>885</th>\n      <td>2015-07-03</td>\n      <td>bare_areas_unconsolidated</td>\n      <td>0</td>\n    </tr>\n    <tr>\n      <th>886</th>\n      <td>2015-07-03</td>\n      <td>water</td>\n      <td>1516228</td>\n    </tr>\n    <tr>\n      <th>887</th>\n      <td>2015-07-03</td>\n      <td>snow_and_ice</td>\n      <td>0</td>\n    </tr>\n  </tbody>\n</table>\n<p>888 rows × 3 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"           date                              lc_class lc_count\n0    1992-07-02                      cropland_rainfed     3759\n1    1992-07-02     cropland_rainfed_herbaceous_cover    16131\n2    1992-07-02  cropland_rainfed_tree_or_shrub_cover        0\n3    1992-07-02                    cropland_irrigated        0\n4    1992-07-02                       mosaic_cropland   312463\n..          ...                                   ...      ...\n883  2015-07-03                            bare_areas      574\n884  2015-07-03               bare_areas_consolidated        0\n885  2015-07-03             bare_areas_unconsolidated        0\n886  2015-07-03                                 water  1516228\n887  2015-07-03                          snow_and_ice        0\n\n[888 rows x 3 columns]","content_type":"text/plain"}}},"children":[],"key":"XGX5TLlKJk"}],"key":"cN3H3nnuQm"}],"key":"bt2NqvDNmr"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We end up with a dataframe that can be used with Altair. However, on closer inspection, there are a few classes that are not present in our subset. We remove these from the dataframe.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"twXA34PHpa"}],"key":"dsLtq8QYKx"}],"key":"ZpMfN3Ag63"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"for lc_flag, lc_flag_name in lc_flags:\n    lc_count_sum = df[df[\"lc_class\"] == lc_flag_name].lc_count.sum()\n    if lc_count_sum == 0:\n        print(f\"Removing {lc_flag_name} from data frame\")\n        df = df[df[\"lc_class\"] != lc_flag_name]\ndf","key":"TdSdlFyLIn"},{"type":"outputs","id":"7P4BEEwg2diXCT2zJ5lMz","children":[{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"Removing no_data from data frame\nRemoving cropland_rainfed_tree_or_shrub_cover from data frame\nRemoving cropland_irrigated from data frame\nRemoving tree_needleleaved_evergreen_closed_to_open from data frame\nRemoving tree_needleleaved_evergreen_closed from data frame\nRemoving tree_needleleaved_evergreen_open from data frame\nRemoving tree_needleleaved_deciduous_closed from data frame\nRemoving tree_needleleaved_deciduous_open from data frame\nRemoving tree_mixed from data frame\nRemoving shrubland_evergreen from data frame\nRemoving shrubland_deciduous from data frame\nRemoving lichens_and_mosses from data frame\nRemoving sparse_tree from data frame\nRemoving sparse_shrub from data frame\nRemoving bare_areas_consolidated from data frame\nRemoving bare_areas_unconsolidated from data frame\nRemoving snow_and_ice from data frame\n"},"children":[],"key":"mlJ1hg9KLj"},{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":13,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>lc_class</th>\n      <th>lc_count</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1992-07-02</td>\n      <td>cropland_rainfed</td>\n      <td>3759</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1992-07-02</td>\n      <td>cropland_rainfed_herbaceous_cover</td>\n      <td>16131</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>1992-07-02</td>\n      <td>mosaic_cropland</td>\n      <td>312463</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>1992-07-02</td>\n      <td>mosaic_natural_vegetation</td>\n      <td>72470</td>\n    </tr>\n    <tr>\n      <th>6</th>\n      <td>1992-07-02</td>\n      <td>tree_broadleaved_evergreen_closed_to_open</td>\n      <td>9744931</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>880</th>\n      <td>2015-07-03</td>\n      <td>tree_cover_flooded_saline_water</td>\n      <td>21072</td>\n    </tr>\n    <tr>\n      <th>881</th>\n      <td>2015-07-03</td>\n      <td>shrub_or_herbaceous_cover_flooded</td>\n      <td>229015</td>\n    </tr>\n    <tr>\n      <th>882</th>\n      <td>2015-07-03</td>\n      <td>urban</td>\n      <td>15941</td>\n    </tr>\n    <tr>\n      <th>883</th>\n      <td>2015-07-03</td>\n      <td>bare_areas</td>\n      <td>574</td>\n    </tr>\n    <tr>\n      <th>886</th>\n      <td>2015-07-03</td>\n      <td>water</td>\n      <td>1516228</td>\n    </tr>\n  </tbody>\n</table>\n<p>504 rows × 3 columns</p>\n</div>","content_type":"text/html"},"text/plain":{"content":"           date                                   lc_class lc_count\n0    1992-07-02                           cropland_rainfed     3759\n1    1992-07-02          cropland_rainfed_herbaceous_cover    16131\n4    1992-07-02                            mosaic_cropland   312463\n5    1992-07-02                  mosaic_natural_vegetation    72470\n6    1992-07-02  tree_broadleaved_evergreen_closed_to_open  9744931\n..          ...                                        ...      ...\n880  2015-07-03            tree_cover_flooded_saline_water    21072\n881  2015-07-03          shrub_or_herbaceous_cover_flooded   229015\n882  2015-07-03                                      urban    15941\n883  2015-07-03                                 bare_areas      574\n886  2015-07-03                                      water  1516228\n\n[504 rows x 3 columns]","content_type":"text/plain"}}},"children":[],"key":"qALezYPdrD"}],"key":"gsgBPnxgTa"}],"key":"wth6Gvgpuj"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Finally, we can create a stacked chart from the Altair library. We assign the x-axis to display the date, the y-axis to show the occurences per class, and we assign a different color to each of the classes.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KWydTer3vq"}],"key":"NI9PPzjpPM"}],"key":"X1cUocAM2Z"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"alt.Chart(df).mark_area().encode(\n    x=\"date:T\",\n    y=alt.Y(\"lc_count:Q\"),\n    color=\"lc_class:N\"\n)","key":"TsCCD9d4tI"},{"type":"outputs","id":"XtnyR-tRE6zdUxo1gTFjd","children":[{"type":"output","jupyter_data":{"output_type":"execute_result","execution_count":14,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"c49383c77663c0f7a9aa3598b2051ffa","path":"/cci-demonstrator-viewers/build/c49383c77663c0f7a9aa3598b2051ffa.html"},"text/plain":{"content":"alt.Chart(...)","content_type":"text/plain"}}},"children":[],"key":"cdayBcD9CG"}],"key":"HWXAibWrmY"}],"key":"IrEyNr7rUz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"A clear increase of cropland becomes visible, with a simultaneous decrease of natural herbaceous vegetation. Note that on the top right of the chart, you can open a menu that provides you with image export options, as well as an alternative insight into the data.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YgRICgRSbK"}],"key":"m6Q9KPUPEv"}],"key":"AzPdSOOQIT"}],"key":"fX5OFN7RaV"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"D3.js Demonstrators","url":"/external-notebooks/esa-cci/ect-demonstrators/demonstrators/d3-js/readme","group":"D3 Js"},"next":{"title":"Visualizing Cloud Fraction Uncertainties with Altair and Plotly","url":"/external-notebooks/esa-cci/ect-demonstrators/demonstrators/d3-js/d3-js-visualise-uncertainties","group":"D3 Js"}}},"domain":"http://localhost:3000"}